@model ETSU_Marketplace.ViewModels.ListingCardViewModel
@{
    ViewData["Title"] = "Listing Details";
}

<div class="listing-details-page">
    <a class="back-link"
       asp-controller="Listings"
       asp-action="@(Model.ListingType == "Lease" ? "Leases" : "Items")">
        ‚Üê Back
    </a>

    <div class="listing-details-card">
        <div class="listing-details-body">
            <h1 class="listing-details-title">@Model.Title</h1>

            @if (!string.IsNullOrWhiteSpace(Model.ShortDescription))
            {
                <p class="listing-details-subtitle">@Model.ShortDescription</p>
            }

            <div class="listing-details-price-row">
                <div class="listing-details-price">$@Model.Price</div>
                <span class="badge">@Model.ListingType</span>

                @if (!string.IsNullOrWhiteSpace(Model.CategoryLabel))
                {
                    <span class="chip">@Model.CategoryLabel</span>
                }

                @if (!string.IsNullOrWhiteSpace(Model.ConditionLabel))
                {
                    <span class="chip">@Model.ConditionLabel</span>
                }
            </div>

            <div class="listing-details-meta">
                <div class="meta-row">
                    <span class="meta-label">Price:</span> <span>$@Model.Price</span>
                </div>
                <div class="meta-row">
                    <span class="meta-label">Type:</span> <span>@Model.ListingType</span>
                </div>
                <div class="meta-row">
                    <span class="meta-label">Category:</span> <span>@Model.CategoryLabel</span>
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.ConditionLabel))
                {
                    <div class="meta-row">
                        <span class="meta-label">Condition:</span> <span>@Model.ConditionLabel</span>
                    </div>
                }
            </div>

            <div class="details-divider"></div>

            <div class="live-chat-wrap">
                <h2 class="live-chat-title">Live Chat</h2>

                <div class="chat-card">
                    <div id="chatLog" class="chat-messages"></div>

                    <div class="chat-composer">
                        <input id="chatInput" class="chat-input" placeholder="Message the seller..." />
                        <button id="sendBtn" class="chat-send-btn" type="button">Send</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>

<script>
    const listingId = @Model.Id;

    function renderMsg(msg) {
        const div = document.createElement("div");
        div.className = "chat-line";

        const t = msg.sentAtUtc ? new Date(msg.sentAtUtc).toLocaleTimeString() : "";
        div.textContent = (t ? `[${t}] ` : "") + (msg.sender ?? "User") + ": " + (msg.text ?? "");

        const log = document.getElementById("chatLog");
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/marketplaceHub")
        .withAutomaticReconnect()
        .build();

    connection.on("ReceiveListingMessage", (msg) => renderMsg(msg));

    async function start() {
        try {
            const history = await fetch(`/chat/listing/${listingId}`).then(r => r.json());
            history.forEach(renderMsg);
        } catch (e) { }

        await connection.start();
        await connection.invoke("JoinListing", listingId);
    }

    document.getElementById("sendBtn").addEventListener("click", async () => {
        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text) return;

        await connection.invoke("SendListingMessage", listingId, text);
        input.value = "";
        input.focus();
    });

    document.getElementById("chatInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("sendBtn").click();
    });

    start();
</script>